

///// Code in Google Earth Engine Code Editor///
/////

// stack image band from image collection to a single image with multi-bands
// (1) select the roi, for this example is Hangzhou;
// (2) use cf_cvg first and avg_rad to output cloud free observation and averaged monthly radiance data of each roi;
          
var roi=ee.FeatureCollection(Hangzhou); // 'Hangzhou' is the shapefile/roi and is the roi used in the example.
var VIIRS=ee.ImageCollection('NOAA/VIIRS/DNB/MONTHLY_V1/VCMCFG').filterBounds(roi).filterDate('2012-04-01','2019-04-01');
//var VIIRS=ee.ImageCollection(MCD12Q1).filterBounds(roi).filterDate('2011-01-01','2019-04-01');
//var VIIRS=ee.Image(image2);

Map.addLayer(VIIRS.first(),{min:0,max:50})

print(VIIRS);
print('Number of image in Collection:',VIIRS.size());

var renameVIIRS=function(scene){
  var NTL=ee.Image(scene.select(['cf_cvg'])).float(); // be careful about the data type 
  var NTL_idx=ee.String('cvg_').cat(ee.String(scene.get('system:index')));
  
  // select cf_cvg for cloud free coverage; and use the following 2 lines to output avg_rad for monthly averaged radiance;
  //var NTL=ee.Image(scene.select(['avg_rad'])).float();
  //var NTL_idx=ee.String('avg_').cat(ee.String(scene.get('system:index'))); 
  
  return NTL.rename(NTL_idx);
};

var VIIRS_Month_Collection=VIIRS.map(renameVIIRS);

var stackCollection=function(collection){
  var first=ee.Image(collection.first()).select([]);
  var appendBands = function(image, previous) {
    return ee.Image(previous).addBands(image);
  };
  return ee.Image(collection.iterate(appendBands, first));
};
var stacked = stackCollection(VIIRS_Month_Collection);
var stacked = stacked.reproject('EPSG:4326', null, 500);
print('stacked image', stacked);

// export to google drive as .tif file with 500m spatial resolution 
Export.image.toDrive({
  image: stacked.clip(roi),
  description: 'imageToDriveExample',
  scale: 500,
  region: roi
});

          
